{
  "name": "Daily Newsletter Digest",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {}
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.3,
      "position": [
        -432,
        -96
      ],
      "id": "c50296f6-ab48-42fc-ad8f-951b1e59aef4",
      "name": "Schedule Trigger"
    },
    {
      "parameters": {
        "operation": "getAll",
        "limit": 50,
        "filters": {
          "labelIds": [
            "Label_323411605141459935"
          ],
          "receivedAfter": "={{ new Date(Date.now() - 24*60*60*1000).toISOString() }}"
        }
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.2,
      "position": [
        256,
        0
      ],
      "id": "a0870bd4-cbd4-42a5-bbf5-137b90dbbe78",
      "name": "Get many messages tom@whyhi",
      "webhookId": "7bacec26-dca9-4f72-b455-93e847fed526",
      "credentials": {
        "gmailOAuth2": {
          "id": "VRjRQ5k8Y50QK1s9",
          "name": "Gmail tom@whyhi.app"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const seen = new Set();\nconst out = [];\n\nfor (const item of items) {\n  const id = item.json.id;\n  if (!id) continue;\n\n  if (seen.has(id)) continue;\n  seen.add(id);\n\n  // Normalize so downstream nodes always use message_id\n  item.json.message_id = id;\n  out.push(item);\n}\n\nreturn out;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        464,
        0
      ],
      "id": "a92a8808-fff9-4e25-8f0d-5984c0bf286c",
      "name": "Deduplicate"
    },
    {
      "parameters": {
        "operation": "get",
        "messageId": "={{$json.message_id}}"
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.2,
      "position": [
        672,
        0
      ],
      "id": "c12eb205-41c0-4302-88fa-f431d119d8d8",
      "name": "Get a message",
      "webhookId": "902e1c15-1161-4c0b-ba16-b2813abc4c87",
      "credentials": {
        "gmailOAuth2": {
          "id": "VRjRQ5k8Y50QK1s9",
          "name": "Gmail tom@whyhi.app"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "function stripHtml(html) {\n  if (!html) return \"\";\n  return html\n    .replace(/<script[\\s\\S]*?<\\/script>/gi, \" \")\n    .replace(/<style[\\s\\S]*?<\\/style>/gi, \" \")\n    .replace(/<[^>]+>/g, \" \")\n    .replace(/&nbsp;/g, \" \")\n    .replace(/&amp;/g, \"&\")\n    .replace(/&lt;/g, \"<\")\n    .replace(/&gt;/g, \">\")\n    .replace(/\\s+/g, \" \")\n    .trim();\n}\n\nfunction extractUrls(text) {\n  if (!text) return [];\n  const re = /https?:\\/\\/[^\\s<>\"')\\]]+/gi;\n  const found = text.match(re) || [];\n  const clean = found\n    .map(u => u.replace(/[),.]+$/g, \"\")) // trim trailing punctuation\n    .filter(u => u.length < 500);\n  return [...new Set(clean)];\n}\n\nfunction toDateString(value) {\n  // Gmail internalDate often arrives as ms since epoch (number or numeric string)\n  const n = typeof value === \"string\" ? Number(value) : value;\n  if (Number.isFinite(n)) {\n    const d = new Date(n);\n    if (!isNaN(d.getTime())) return d.toISOString();\n  }\n  // if it already looks like a date string, keep it\n  if (typeof value === \"string\" && value.length) return value;\n  return \"\";\n}\n\nreturn items.map(item => {\n  const j = item.json || {};\n\n  // n8n Gmail \"Get a message\" shapes can vary; try common places\n  const subject =\n    j.subject ||\n    j.headers?.subject ||\n    j.payload?.headers?.subject ||\n    \"\";\n\n  const from =\n    j.from ||\n    j.headers?.from ||\n    \"\";\n\n  const date =\n    toDateString(j.date || j.internalDate || \"\");\n\n  const snippet = (j.snippet || \"\").toString();\n\n  // Body candidates\n  const bodyText =\n    (j.text || j.body?.text || \"\").toString();\n\n  const bodyHtml =\n    (j.html || j.body?.html || \"\").toString();\n\n  // Best-effort content\n  const text = bodyText && bodyText.length > 0\n    ? bodyText\n    : stripHtml(bodyHtml);\n\n  const contentSource = (text && text.length > 0) ? text : snippet;\n  const content = (contentSource || \"\").slice(0, 6000);\n\n  const urls = extractUrls((text || \"\") + \"\\n\" + (snippet || \"\")).slice(0, 10);\n\n  const messageId = (j.message_id || j.id || \"\").toString();\n  const threadId = (j.threadId || j.thread_id || \"\").toString();\n\n  // All emails are in tom@whyhi.app account (u/0)\n  const gmailLink = messageId\n    ? `https://mail.google.com/mail/u/0/#all/${messageId}`\n    : \"\";\n\n  item.json.email_packet = {\n    message_id: messageId,\n    thread_id: threadId,\n    subject: subject || \"\",\n    from: from || \"\",\n    date: date || \"\",\n    snippet: snippet.slice(0, 500),\n    content,\n    urls,\n    gmail_link: gmailLink\n  };\n\n  return item;\n});"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        880,
        0
      ],
      "id": "6fb28699-146a-4489-908d-671e57649ad5",
      "name": "Extract Email Packet"
    },
    {
      "parameters": {
        "jsCode": "const packets = items\n  .map(i => i.json.email_packet)\n  .filter(Boolean);\n\nreturn [{\n  json: {\n    run_date: new Date().toISOString().slice(0,10),\n    count: packets.length,\n    packets\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1088,
        0
      ],
      "id": "68ef63a2-2af5-4c9c-9c13-d91357f39cb1",
      "name": "Collect all email_packets"
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4.1-mini",
          "mode": "list",
          "cachedResultName": "GPT-4.1-MINI"
        },
        "responses": {
          "values": [
            {
              "role": "system",
              "content": "You are WhyHi's full-time email relevance analyst for a solo founder. Your job is to extract the highest-signal, most actionable information from a batch of emails and produce a daily digest.\n\nWhyHi context:\n- WhyHi is a modern calling platform that makes phone calls intentional by adding context before pickup: call intention + call duration.\n- WhyHi is building toward a platform layer for live calling with lightweight relationship/CRM mechanics and future AI-powered features (summaries, insights, reminders, automation).\n\nGuiding principles:\n- Be concise, practical, and actionable.\n- Avoid generic fluff; prefer concrete takeaways, tools, tactics, product patterns, numbers, and named entities.\n- Do not invent facts. Use only what's in the provided email batch JSON.\n- If subject/from are missing, infer a short title from snippet/content.\n- Use your best judgment to categorize items. If something could fit multiple categories, pick the best fit; misclassification is not critical.\n\nCategories (use these buckets):\n- Product: comms/calling UX, feature ideas, platform/call flows, trust/safety patterns, competitor product moves in comms\n- Growth: marketing, positioning, distribution, onboarding, retention, PR, partnerships, community, GTM tactics, upcoming events in Los Angeles for tech startup founders, entrepreneurs\n- Operations: founder productivity, AI tools, agent workflows, n8n/MCP patterns, process, reliability, execution systems\n- Finance: funding rounds, VC/angel insights, pricing/monetization, financial modeling, unit economics, infra cost signals"
            },
            {
              "content": "=Analyze this batch of emails (JSON) and return a daily digest for WhyHi.\n\nReturn VALID HTML ONLY (no markdown, no code blocks). Use <h2>, <ul>, <li>, <ol>, <b>, and <a>.\nEvery <li> MUST include: style=\"margin: 0 0 12px 0;\"\n\nWhat to include:\n- Include only items you judge relevant/useful for WhyHi (high-signal). If something isn't useful, omit it.\n- For each included item, add a relevance score 0â€“10 and exactly one next action.\n- End each item with clickable links:\n  1) Open email (gmail_link)\n  2) Up to 3 source URLs from urls[] (if present)\n- If urls[] is empty, show only "Open email".\n- Never write "unclear link" / "no direct link".\n\nOutput structure (follow exactly):\n\n<h2>ðŸ”§ Product</h2>\n<ul>\n  <!-- items OR the single \"No relevant items today.\" line -->\n</ul>\n\n<h2>ðŸ“ˆ Growth</h2>\n<ul>\n  <!-- items OR the single \"No relevant items today.\" line -->\n</ul>\n\n<h2>ðŸ§  Operations</h2>\n<ul>\n  <!-- items OR the single \"No relevant items today.\" line -->\n</ul>\n\n<h2>ðŸ’° Finance</h2>\n<ul>\n  <!-- items OR the single \"No relevant items today.\" line -->\n</ul>\n\n<h2>Top 7 Next Actions</h2>\n<ol>\n  <!-- up to 7 actions -->\n</ol>\n\nBullet format (use exactly this pattern inside each <li>):\n<li style=\"margin: 0 0 12px 0;\">\n  <b>[Score]</b> Title â€” why it matters â€” next action â€”\n  <a href=\"GMAIL_LINK\">Open email</a> | <a href=\"URL1\">Source 1</a> | <a href=\"URL2\">Source 2</a> | <a href=\"URL3\">Source 3</a>\n</li>\n\nRules:\n- If a section has no included items, write exactly: <li style=\"margin: 0 0 12px 0;\">No relevant items today.</li>\n- Keep each bullet to 1â€“2 lines max (don't ramble).\n- The "Top 7 Next Actions" list should be short, specific, and derived from the items above.\n\nNow here is the batch JSON:\n{{ JSON.stringify($json.packets) }}"
            }
          ]
        },
        "builtInTools": {},
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 2.1,
      "position": [
        1296,
        0
      ],
      "id": "b78fb3dc-c719-437d-8df3-80050d0baf22",
      "name": "Message a model",
      "credentials": {
        "openAiApi": {
          "id": "LGKQZjsftUY3Yu7p",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "sendTo": "tom@whyhi.app",
        "subject": "WhyHi Daily Newsletter Digest",
        "message": "={{ $json.output?.[0]?.content?.[0]?.text ?? $json.text ?? JSON.stringify($json) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.2,
      "position": [
        1504,
        0
      ],
      "id": "c37b445e-1dfb-450a-ac3f-0a57cd6f795f",
      "name": "Send a message",
      "webhookId": "e7c5f510-5d18-4d85-92ba-81d49b8b4b34",
      "credentials": {
        "gmailOAuth2": {
          "id": "VRjRQ5k8Y50QK1s9",
          "name": "Gmail tom@whyhi.app"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        64,
        -80
      ],
      "id": "aeb5f33e-0934-4825-89be-3b486b22efeb",
      "name": "Merge Triggers"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "/wos/intent/daily_newsletter_digest_v0",
        "responseMode": "responseNode",
        "options": {
          "rawBody": false
        }
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -432,
        -288
      ],
      "id": "ab55a2b3-4332-4af1-bb7d-0db75a976325",
      "name": "Intent Webhook",
      "webhookId": "a1945da6-8038-4a31-828b-5c8096690711"
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "{ \"message\": \"Workflow was started\" }",
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -256,
        -400
      ],
      "id": "74c2ff26-d104-41d9-aad9-e7952991cf17",
      "name": "Ack"
    },
    {
      "parameters": {
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        -80,
        -400
      ],
      "id": "412c9af9-d245-4414-9299-58ac0878f94c",
      "name": "Respond to Webhook1"
    }
  ],
  "pinData": {},
  "connections": {
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "Merge Triggers",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Get many messages tom@whyhi": {
      "main": [
        [
          {
            "node": "Deduplicate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Deduplicate": {
      "main": [
        [
          {
            "node": "Get a message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get a message": {
      "main": [
        [
          {
            "node": "Extract Email Packet",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Email Packet": {
      "main": [
        [
          {
            "node": "Collect all email_packets",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Collect all email_packets": {
      "main": [
        [
          {
            "node": "Message a model",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Message a model": {
      "main": [
        [
          {
            "node": "Send a message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Triggers": {
      "main": [
        [
          {
            "node": "Get many messages tom@whyhi",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Intent Webhook": {
      "main": [
        [
          {
            "node": "Ack",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge Triggers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ack": {
      "main": [
        [
          {
            "node": "Respond to Webhook1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Respond to Webhook1": {
      "main": [
        []
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false,
    "timeSavedMode": "fixed",
    "saveDataSuccessExecution": "all",
    "callerPolicy": "workflowsFromSameOwner"
  },
  "versionId": "1a966720-e052-4974-8de2-259b4551d3bc",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "0239ac923949e74ef6e4e5006e111fc060979a1c83b694a314eba3c9a0fb1b39"
  },
  "id": "3idGzhA3JtLhI7Pb",
  "tags": []
}
